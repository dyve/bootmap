(function(a){"use strict";var b={mapParameters:{lat:{type:"float"},lng:{type:"float"},zoom:{type:"int",value:8}},layerParameters:{"stroke-color":{type:"string"},"stroke-opacity":{type:"float"},"stroke-weight":{type:"integer"},"fill-color":{type:"string"},"fill-opacity":{type:"float"}},OverlayType:{POLYGON:"POLYGON",POLYLINE:"POLYLINE",MARKER:"MARKER"}},c=function(b){var c,d;if(a.isArray(b)&&b.length===2){c=parseFloat(b[1]),d=parseFloat(b[0]);if(!isNaN(c)&&!isNaN(d))return new google.maps.LatLng(c,d)}throw new Error("Invalid coordinate. Expected array with 2 floats, got "+x(b))},d=function(a){var b,d=[];for(b=0;b<a.length;b++)d.push(c(a[b]));return d},e=function(a){var b,c=[];for(b=0;b<a.length;b++)c.push(d(a[b]));return c},f=function(a,c,d,e){var f;switch(a){case b.OverlayType.MARKER:f=g(c,d);break;case b.OverlayType.POLYLINE:f=h(c,d);break;case b.OverlayType.POLYGON:f=i(c,d);break;default:throw new Error("Ilegal overlay type: "+a)}return f.geomIndex=e,f},g=function(b,d,e){var f,g=a.extend({},d),h=g.editable;return delete g.editable,g.position=c(b),f=new google.maps.Marker(g),h&&(f.setDraggable(!0),google.maps.event.addListener(f,"dragend",function(){u(f)})),f},h=function(b,c){var e=a.extend({},c);return e.path=d(b),new google.maps.Polyline(e)},i=function(b,c){var d=a.extend({},c);return d.paths=e(b),new google.maps.Polygon(d)},j=function(b){var c=b.replace(/([\d\.])\s+([\d\.])/g,"$1#$2").replace(/\s/g,"").replace(/\(([\d\.])/g,"(($1").replace(/([\d\.])\)/g,"$1))").replace(/([\d\.])\,([\d\.])/g,"$1),($2").replace(/\#/g,",").replace(/\)/g,"]").replace(/\(/g,"[");try{c=a.parseJSON(c)}catch(d){throw new Error("Cannot parse WKT path to coordinates array")}return c},k=function(b){var c,d,e,f=b.indexOf("(");if(f===-1)throw new Error("Invalid WKT, format not recognized");c=a.trim(b.substr(0,f)).toUpperCase();if(!c)throw new Error("Invalid WKT, no type specified");d=b.substr(f),e=j(d);switch(c){case"POINT":if(e.length!==1)throw"Invalid WKT, type POINT should have 1 coordinate";c="Point",e=e[0];break;case"MULTIPOINT":c="MultiPoint";break;case"LINESTRING":c="LineString";break;case"MULTILINESTRING":c="MultiLineString";break;case"POLYGON":c="Polygon";break;case"MULTIPOLYGON":c="MultiPolygon";break;default:throw"Invalid WKT, unknown type "+c}return{type:c,coordinates:e}},l=function(b,c){var d;switch(c.toLowerCase()){case"wkt":d=k(b);break;case"json":d=a.parseJSON(b);break;default:d=null}return d},m=function(a,b){return a.attr("data-"+b)},n=function(c,d){var e=a(c),f=e.filter(":input").length>0,g=m(e,"format"),h,i,j={};return h=d.map||m(e,"map"),i=d.text||(f?e.val():e.html()),g&&i?(a.each(b.layerParameters,function(a,b){var c=d[a];undefined===c&&(c=m(e,a));switch(b.type){case"int":c=parseInt(c,10),isNaN(c)&&(c=b.value);break;case"float":c=parseFloat(c),isNaN(c)&&(c=b.value)}j[a]=c}),j.elem=c,j.$elem=e,j.text=i,j.map=h,j.format=g,j.geom=l(i,g),j.editable=f,j):null},o=function(c,d){var e,f={};return a.each(b.mapParameters,function(a,b){var e=d[a];undefined===e&&(e=m(c,a));switch(b.type){case"int":e=parseInt(e,10),isNaN(e)&&(e=b.value);break;case"float":e=parseFloat(e),isNaN(e)&&(e=b.value)}f[a]=e}),f.layers=[],f},p=function(a){return a instanceof google.maps.Marker?b.OverlayType.MARKER:a instanceof google.maps.Polyline?b.OverlayType.POLYLINE:a instanceof google.maps.Polygon?b.OverlayType.POLYGON:null},q=function(a){var b,c;if(a instanceof google.maps.LatLng)return[a.lng(),a.lat()];c=[];for(b=0;b<a.length;b++)c.push(q(a[b]));return c},r=function(a){return q(E(a))},s=function(a){var c=p(a),d=r(a);switch(c){case b.OverlayType.MARKER:c="Point",d=d[0][0];break;case b.OverlayType.POLYLINE:c="LineString",d=d[0];break;case b.OverlayType.POLYGON:c="Polygon";break;default:throw new Error("Invalid overlay type: "+c)}return{type:c,coordinates:d}},t=function(b,c,d){var e,f,g;g=c.split(","),f=parseInt(g.shift(),10);if(g.length===0)if(a.isArray(b))b[f]=d.coordinates;else if(b.type.substr(0,5)==="Multi")b.coordinates[f]=d.coordinates;else{if(b.type!=="GeometryCollection")throw new Error("Invalid Geometry type: "+b.type);b.geometries[f]=d}else{if(b.type!=="GeometryCollection")throw new Error("Invalid Geometry type: "+b.type);e=b.geometries[f],t(e,g.join(","),d)}},u=function(a){var b=s(a),c=a.geomIndex;if(c==="0")a.layer.geom=b;else{if(c.substr(0,2)!=="0,")throw new Error("Invalid geomIndex "+c);t(a.layer.geom,c.substr(2),b)}var d=a.layer.format,e;switch(d){case"wkt":e=w(a.layer.geom);break;case"json":e=x(a.layer.geom);break;default:throw"No output support for format "+d}a.layer.$elem.filter(":input").val(e)},v=function(b){var c,d;if(b===null)return" EMPTY ";if(!a.isArray(b[0]))return b[0]+" "+b[1];d=[];for(c=0;c<b.length;c++)d[c]=v(b[c]);return"("+d.join(",")+")"},w=function(a){var b,c;if(a.type==="GeometryCollection"){c=[];for(b=0;b<a.geometries.length;b++)c.push(w(a.geometries[b]));c="GEOMETRYCOLLECTION("+c.join(",")+")"}else c=a.type.toUpperCase()+v(a.coordinates);return c},x=function(b){var c,d=[];if(a.isArray(b)){for(c=0;c<b.length;c++)d.push(x(b[c]));return"[ "+d.join(", ")+" ]"}return typeof b=="object"?(a.each(b,function(a,b){d.push('"'+a+'": '+x(b))}),"{ "+d.join(", ")+" }"):typeof b=="string"?'"'+b+'"':""+b},y=function(a){var b=function(){u(a)},c,d,e=a.getPaths();for(c=0;c<e.getLength();c++)d=e.getAt(c),google.maps.event.addListener(d,"insert_at",b),google.maps.event.addListener(d,"remove_at",b),google.maps.event.addListener(d,"set_at",b)},z=function(a){var b=function(){u(a)},c=a.getPath();google.maps.event.addListener(c,"insert_at",b),google.maps.event.addListener(c,"remove_at",b),google.maps.event.addListener(c,"set_at",b)},A=function(a,c,d){var e,g,h;d||(d="0");if(a.type==="GeometryCollection"){g=[];for(e=0;e<a.geometries.length;e++)h=d+","+e,g.push(A(a.geometries[e],c,h))}else{var i=function(b,f){var g=[];for(e=0;e<a.coordinates.length;e++)h=d+","+e,g.push(A({type:b,coordinates:a.coordinates[e]},c,h));return g};switch(a.type){case"Point":g=f(b.OverlayType.MARKER,a.coordinates,c,d);break;case"LineString":g=f(b.OverlayType.POLYLINE,a.coordinates,c,d),z(g);break;case"Polygon":g=f(b.OverlayType.POLYGON,a.coordinates,c,d),y(g);break;case"MultiPoint":g=i("Point",a.coordinates);break;case"MultiLineString":g=i("LineString",a.coordinates);break;case"MultiPolygon":g=i("Polygon",a.coordinates);break;default:throw Error("Bootmap cannot handle geometries of type '"+a.type+"'")}}return g},B=function(b){var c,d,e,f=[];if(!a.isArray(b))f.push(b);else for(c=0;c<b.length;c++){e=B(b[c]);for(d=0;d<e.length;d++)f.push(e[d])}return f},C=function(b){var c,d=null,e={editable:b.editable,strokeColor:b["stroke-color"],strokeOpacity:b["stroke-opacity"],strokeWeight:b["stroke-weight"],fillColor:b["fill-color"],fillOpacity:b["fill-opacity"]};b.format==="wkt-file"?d=new google.maps.KmlLayer(b.text):d=A(b.geom,e),d=B(d),a.isArray(d)||(d=[d]);for(c=0;c<d.length;c++)d[c].layer=b;return d},D=function(a,b){var c=new google.maps.LatLng(b.lat,b.lng);return new google.maps.Map(a,{center:c,zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP})},E=function(a){var b,c;if(a.getPaths){c=a.getPaths(),b=[];for(var d=0;d<c.getLength();d++)b.push(c.getAt(d).getArray())}else a.getPath?b=[a.getPath().getArray()]:a.getPosition&&(b=[[a.getPosition()]]);return b},F=function(a){var b=new google.maps.LatLngBounds,c,d=E(a),e,f;if(d)for(e=0;e<d.length;e++){c=d[e];for(f=0;f<c.length;f++)b.extend(c[f])}return b},G=function(a){var b,c,d,e=[];for(b=0;b<a.length;b++){d=C(a[b]);for(c=0;c<d.length;c++)e.push(d[c])}return e};b.initMap=function(c,d){var e=a.extend({},d),f=a(c),g=o(f,e),h=a.trim(f.html()),i=D(c,g);f.data({map:i,mapData:g}),h&&(e.text=h,e.map=f,b.initLayer(c,e))},b.initLayer=function(b,c){var d,e,f,g,h,i,j,k,l=a.extend({},c);g=n(b,l);if(!g)return;g.map&&(typeof g.map=="object"?f=g.map:f=a("#"+g.map),d=f.data("map"),e=f.data("mapData"));if(!f||!d||!e)throw new Error("Cannot find map: "+g.map?g.map:"(none)");e.layers.push(g),h=d.getBounds(),h||(h=new google.maps.LatLngBounds),j=G(e.layers);for(k=0;k<j.length;k++)i=j[k],i.setMap(d),h.union(F(i));d.fitBounds(h),f.data({map:d,mapData:e})},b.googleMapsLoaded=function(){return typeof google!="undefined"&&typeof google.maps!="undefined"&&typeof google.maps.drawing!="undefined"},b.init=function(){a("[data-map]").bootmap()},a.fn.bootmap=function(c){var d=[];return c=a.extend({},a.fn.options,c),this.each(function(){var e=a(this).attr("data-map");!e||e===a(this).attr("id")?b.initMap(this,c):d.push(this)}),a.each(d,function(a,d){b.initLayer(d,c)}),this},a.fn.bootmap.defaults={},window.bootmap=b,a(function(){b.googleMapsLoaded()?b.init():a("body").append('<script src="//maps.googleapis.com/maps/api/js?libraries=drawing&sensor=false&callback=bootmap.init"></script>')})})(jQuery);