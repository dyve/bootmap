(function(a){"use strict";var b={mapParameters:{lat:{type:"float"},lng:{type:"float"},zoom:{type:"int",value:8},input:{}},OverlayType:{POLYGON:"POLYGON",POLYLINE:"POLYLINE",MARKER:"MARKER"}},c=function(b){var c,d;if(a.isArray(b)&&b.length===2){c=parseFloat(b[1]),d=parseFloat(b[0]);if(!isNaN(c)&&!isNaN(d))return new google.maps.LatLng(c,d)}throw new Error("Invalid coordinate. Expected array with 2 floats, got "+z(b))},d=function(a){var b,d=[];for(b=0;b<a.length;b++)d.push(c(a[b]));return d},e=function(a){var b,c=[];for(b=0;b<a.length;b++)c.push(d(a[b]));return c},f=function(a,c,d,e){var f;switch(a){case b.OverlayType.MARKER:f=g(c,d);break;case b.OverlayType.POLYLINE:f=h(c,d);break;case b.OverlayType.POLYGON:f=i(c,d);break;default:throw new Error("Ilegal overlay type: "+a)}return f.geomIndex=e,f},g=function(b,d,e){var f,g=a.extend({},d),h=g.editable;return delete g.editable,g.position=c(b),f=new google.maps.Marker(g),h&&(f.setDraggable(!0),google.maps.event.addListener(f,"dragend",function(){w(f)})),f},h=function(b,c){var e=a.extend({},c);return e.path=d(b),new google.maps.Polyline(e)},i=function(b,c){var d=a.extend({},c);return d.paths=e(b),new google.maps.Polygon(d)},j=function(a){var b,c=new google.maps.LatLngBounds;for(b=0;b<a.getLength();b++)c.extend(a.getAt(b));return c},k=function(a){var b,c=a.getPaths(),d=new google.maps.LatLngBounds;for(b=0;b<c.getLength();b++)d.union(j(c.getAt(b)));return d},l=function(b){var c=b.replace(/([\d\.])\s+([\d\.])/g,"$1#$2").replace(/\s/g,"").replace(/\(([\d\.])/g,"(($1").replace(/([\d\.])\)/g,"$1))").replace(/([\d\.])\,([\d\.])/g,"$1),($2").replace(/\#/g,",").replace(/\)/g,"]").replace(/\(/g,"[");try{c=a.parseJSON(c)}catch(d){throw new Error("Cannot parse WKT path to coordinates array")}return c},m=function(b){var c,d,e,f,g=b.indexOf("(");if(g===-1)throw new Error("Invalid WKT, format not recognized");c=a.trim(b.substr(0,g)).toUpperCase();if(!c)throw new Error("Invalid WKT, no type specified");d=b.substr(g),f=l(d);switch(c){case"POINT":if(f.length!==1)throw"Invalid WKT, type POINT should have 1 coordinate";c="Point",f=f[0];break;case"MULTIPOINT":c="MultiPoint";break;case"LINESTRING":c="LineString";break;case"MULTILINESTRING":c="MultiLineString";break;case"POLYGON":c="Polygon";break;case"MULTIPOLYGON":c="MultiPolygon";break;default:throw"Invalid WKT, unknown type "+c}return{type:c,coordinates:f}},n=function(b,c){var d;switch(c.toLowerCase()){case"wkt":d=m(b);break;case"json":d=a.parseJSON(b);break;default:d=null}return d},o=function(a,b){return a.attr("data-"+b)},p=function(b){var c=a(b),d=c.filter(":input").length>0,e=d?c.val():c.html(),f=o(c,"type");return f&&e?{elem:b,$elem:c,text:e,type:f,geom:n(e,f),editable:d}:null},q=function(c,d){var e,f={};return a.each(b.mapParameters,function(a,b){var e=d[a];undefined===e&&(e=o(c,a));switch(b.type){case"int":e=parseInt(e,10),isNaN(e)&&(e=b.value);break;case"float":e=parseFloat(e),isNaN(e)&&(e=b.value)}f[a]=e}),f.layers=[],e=p(c[0]),e&&f.layers.push(e),f.input&&a(f.input).each(function(){e=p(this),e&&f.layers.push(e)}),f},r=function(a){return a instanceof google.maps.Marker?b.OverlayType.MARKER:a instanceof google.maps.Polyline?b.OverlayType.POLYLINE:a instanceof google.maps.Polygon?b.OverlayType.POLYGON:null},s=function(a){var b,c;if(a instanceof google.maps.LatLng)return[a.lng(),a.lat()];c=[];for(b=0;b<a.length;b++)c.push(s(a[b]));return c},t=function(a){return s(G(a))},u=function(a){var c=r(a),d=t(a);switch(c){case b.OverlayType.MARKER:c="Point",d=d[0][0];break;case b.OverlayType.POLYLINE:c="LineString",d=d[0];break;case b.OverlayType.POLYGON:c="Polygon";break;default:throw new Error("Invalid overlay type: "+c)}return{type:c,coordinates:d}},v=function(b,c,d){var e,f,g;g=c.split(","),f=parseInt(g.shift(),10);if(g.length===0)if(a.isArray(b))b[f]=d.coordinates;else if(b.type.substr(0,5)==="Multi")b.coordinates[f]=d.coordinates;else{if(b.type!=="GeometryCollection")throw new Error("Invalid Geometry type: "+b.type);b.geometries[f]=d}else{if(b.type!=="GeometryCollection")throw new Error("Invalid Geometry type: "+b.type);e=b.geometries[f],v(e,g.join(","),d)}},w=function(a){var b=u(a),c=a.geomIndex;if(c==="0")a.layer.geom=b;else{if(c.substr(0,2)!=="0,")throw new Error("Invalid geomIndex "+c);v(a.layer.geom,c.substr(2),b)}var d=a.layer.type,e;switch(d){case"wkt":e=y(a.layer.geom);break;case"json":e=z(a.layer.geom);break;default:throw"No output support for type "+d}a.layer.$elem.filter(":input").val(e)},x=function(b){if(!a.isArray(b[0]))return b[0]+" "+b[1];var c=[];for(var d=0;d<b.length;d++)c[d]=x(b[d]);return"("+c.join(",")+")"},y=function(a){return a.type.toUpperCase()+x(a.coordinates)},z=function(b){var c,d=[];if(a.isArray(b)){for(c=0;c<b.length;c++)d.push(z(b[c]));return"[ "+d.join(", ")+" ]"}return typeof b=="object"?(a.each(b,function(a,b){d.push('"'+a+'": '+z(b))}),"{ "+d.join(", ")+" }"):typeof b=="string"?'"'+b+'"':""+b},A=function(a){var b=function(){w(a)},c,d,e=a.getPaths();for(c=0;c<e.getLength();c++)d=e.getAt(c),google.maps.event.addListener(d,"insert_at",b),google.maps.event.addListener(d,"remove_at",b),google.maps.event.addListener(d,"set_at",b)},B=function(a){var b=function(){w(a)},c=a.getPath;google.maps.event.addListener(c,"insert_at",b),google.maps.event.addListener(c,"remove_at",b),google.maps.event.addListener(c,"set_at",b)},C=function(a,c,d){var e,g,h;d||(d="0");if(a.type==="GeometryCollection"){g=[];for(e=0;e<a.geometries.length;e++)h=d+","+e,g.push(C(a.geometries[e],c,h))}else{var i=function(b,f){var g=[];for(e=0;e<a.coordinates.length;e++)h=d+","+e,g.push(C({type:b,coordinates:a.coordinates[e]},c,h));return g};switch(a.type){case"Point":g=f(b.OverlayType.MARKER,a.coordinates,c,d);break;case"LineString":g=f(b.OverlayType.POLYLINE,a.coordinates,c,d),B(g);break;case"Polygon":g=f(b.OverlayType.POLYGON,a.coordinates,c,d),A(g);break;case"MultiPoint":g=i("Point",a.coordinates);break;case"MultiLineString":g=i("LineString",a.coordinates);break;case"MultiPolygon":g=i("Polygon",a.coordinates);break;default:throw Error("Bootmap cannot handle geometries of type '"+a.type+"'")}}return g},D=function(b){var c,d,e,f=[];if(!a.isArray(b))f.push(b);else for(c=0;c<b.length;c++){e=D(b[c]);for(d=0;d<e.length;d++)f.push(e[d])}return f},E=function(b){var c,d=null,e={editable:b.editable};b.type==="wkt-file"?d=new google.maps.KmlLayer(b.text):d=C(b.geom,e),d=D(d),a.isArray(d)||(d=[d]);for(c=0;c<d.length;c++)d[c].layer=b;return d},F=function(a,b){var c=new google.maps.LatLng(b.lat,b.lng);return new google.maps.Map(a,{center:c,zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP})},G=function(a){var b,c;if(a.getPaths){c=a.getPaths(),b=[];for(var d=0;d<c.getLength();d++)b.push(c.getAt(d).getArray())}else a.getPath?b=[a.getPath().getArray()]:a.getPosition&&(b=[[a.getPosition()]]);return b},H=function(a){var b=new google.maps.LatLngBounds,c,d=G(a),e,f;if(d)for(e=0;e<d.length;e++){c=d[e];for(f=0;f<c.length;f++)b.extend(c[f])}return b},I=function(a){var b,c,d,e=[];for(b=0;b<a.length;b++){d=E(a[b]);for(c=0;c<d.length;c++)e.push(d[c])}return e};b.initElem=function(b,c){var d,e,f,g,h=a(b),i=q(h,c),j=F(b,i);if(i.layers.length){g=new google.maps.LatLngBounds,f=I(i.layers);for(d=0;d<f.length;d++)e=f[d],e.setMap(j),g.union(H(e));j.fitBounds(g)}h.data({map:j,mapData:i})},b.googleMapsLoaded=function(){return typeof google!="undefined"&&typeof google.maps!="undefined"&&typeof google.maps.drawing!="undefined"},b.init=function(){a("[data-map]").bootmap()},a.fn.bootmap=function(c){return c=a.extend({},a.fn.options,c),this.each(function(){b.initElem(this,c)})},a.fn.bootmap.defaults={},window.bootmap=b,a(function(){b.googleMapsLoaded()?b.init():a("body").append('<script src="//maps.googleapis.com/maps/api/js?libraries=drawing&sensor=false&callback=bootmap.init"></script>')})})(jQuery);